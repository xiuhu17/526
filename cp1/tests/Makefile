LEVEL = ..

## change or use make TARGET=inputfilename
TARGET=trivial

## replace LLVMROOT and SROALIB as appropriate
NETID = `whoami`
LLVMROOT ?= $(HOME)/llvm
SROALIB  ?= $(LEVEL)/lib/libSROA.so

LLVMGCC = $(LLVMROOT)/bin/clang
LLVMAS  = $(LLVMROOT)/bin/llvm-as
LLVMDIS = $(LLVMROOT)/bin/llvm-dis
LLVMOPT = $(LLVMROOT)/bin/opt


## Other choices: test or comparecfe (these will be provided later)
default: debug
DEBUGOPTS =  -verify -inline -mem2reg -simplifycfg -mem2reg -globalopt -globaldce -instcombine -adce -instcombine -simplifycfg

testsimple: debug
debug: $(TARGET).debug.bc
disassembly: $(TARGET).llvm.ll $(TARGET).debug.ll

## test (implement yourself) can be used to test out your solution with a known comparison target.
## I will use different pass pipelines during the actual testing.
## Please test your solution with different pass pipelines when using the test target.
test: $(TARGET).test.bc


.PRECIOUS: %.ll


%.ll: %.bc
	$(LLVMDIS) -f $<


%.llvm.bc: %.c
	$(LLVMGCC) -S -emit-llvm -o - $< | $(LLVMAS) -o=$@

%.debug.bc: %.llvm.bc
	$(LLVMOPT) $(DEBUGOPTS) < $< | \
	$(LLVMOPT) -load $(SROALIB) -scalarrepl-netid -o=$@

clean:
	$(RM) -f *.debug.bc *.test.bc *.llvm.bc *.ll
